# CloudPaste 虚拟主机配置
# Map 和 Upstream 配置在 cloudpaste-maps.conf 中

server {
    listen 5280 default_server;
    listen [::]:5280 default_server;
    server_name _;
    root /app/frontend;
    index index.html;

    # 访问日志
    access_log /cloudpaste/logs/nginx/access.log;
    error_log /cloudpaste/logs/nginx/error.log warn;

    # 防止重定向时丢失端口号
    absolute_redirect off;
    port_in_redirect off;

    # 文件上传大小限制
    client_max_body_size 100M;

    # API 路径（使用 ^~ 提高优先级，避免被正则规则拦截）
    location ^~ /api {
        proxy_pass http://fastapi_backend;

        # 完整的反向代理头（保留客户端原始信息）
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;

        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # 超时设置（WebSocket 需要长连接）
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # 禁用缓冲（对 WebSocket 很重要）
        proxy_buffering off;
    }

    # API 文档（使用 ^~ 提高优先级）
    location ^~ /docs {
        proxy_pass http://fastapi_backend;

        # 完整的反向代理头
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;
    }

    # WebSocket 专用路径（使用 ^~ 提高优先级）
    location ^~ /ws/ {
        proxy_pass http://fastapi_backend;

        # 完整的反向代理头
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $forwarded_port;

        # WebSocket 必需的头
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # 禁用缓冲和超时设置
        proxy_buffering off;
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # 健康检查端点
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Next.js 静态资源（强缓存）
    location /_next/static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Next.js 数据文件
    location /_next/data/ {
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }

    # Next.js 图片优化
    location /_next/image {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 公共静态文件（排除 /api、/docs、/ws 路径）
    location ~* ^/(?!api/|docs|ws/).*\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location /favicon.ico {
        expires 1y;
        add_header Cache-Control "public";
        access_log off;
    }

    location /robots.txt {
        access_log off;
    }

    # 前端路由 fallback（必须放在最后）
    location / {
        # 尝试顺序：
        # 1. 直接文件 ($uri)
        # 2. 添加 .html 后缀 ($uri.html)
        # 3. 目录下的 index.html ($uri/index.html)
        # 4. 最后回退到根 index.html
        try_files $uri $uri.html $uri/index.html /index.html;

        # 添加错误页面处理
        error_page 404 /index.html;
    }
}
